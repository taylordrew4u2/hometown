<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bit Builder - Chat</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <h1>ðŸŽ­ Bit Builder</h1>
        </div>
        <div class="header-right">
          <a id="bitbinder-btn" class="btn-secondary" href="binder.html"
            >ðŸ“š Bitbinder</a
          >
          <button id="logout-btn" class="btn-secondary">Logout</button>
        </div>
      </header>

      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <button
          id="voice-tab"
          class="mode-btn active"
          onclick="switchMode('voice')"
        >
          ðŸŽ¤ Voice
        </button>
        <button id="text-tab" class="mode-btn" onclick="switchMode('text')">
          ðŸ’¬ Text
        </button>
      </div>

      <!-- Voice Mode - ElevenLabs widget -->
      <main id="voice-mode" class="chat-container">
        <elevenlabs-convai
          agent-id="agent_7401ka31ry6qftr9ab89em3339w9"
        ></elevenlabs-convai>
      </main>

      <!-- Text Mode - type to the agent -->
      <main id="text-mode" class="chat-container" style="display: none">
        <div class="text-chat-wrapper">
          <div id="messages-area" class="messages-area">
            <div class="message assistant-message">
              Hey there! ðŸŽ­ I'm Bit Builder, your comedy writing assistant. Type
              a message to get started!
            </div>
          </div>
          <div class="input-area">
            <form id="text-chat-form" class="input-controls">
              <textarea
                id="message-input"
                placeholder="Type your message..."
                rows="1"
              ></textarea>
              <button type="submit" id="send-btn" class="btn-primary">
                Send
              </button>
            </form>
          </div>
        </div>
      </main>

      <!-- Configure the agent with system prompt and tool definitions -->
      <script>
        // Override config is picked up by the widget on init
        window.__elevenlabs_convai_override = {
          agent: {
            prompt: {
              prompt:
                'You are Bit Builder, an AI comedy writing assistant. You help users create, develop, and refine comedy material. You\'re witty, supportive, and knowledgeable about comedy writing techniques.\n\nIMPORTANT: You have a tool called save_joke that saves jokes to the user\'s Bitbinder (their personal joke collection). When you and the user agree on a joke that\'s ready to save, call the save_joke tool with:\n- content: the final joke text\n- tags: an array of relevant tags (e.g. ["pun", "short"], ["observational", "relatable"])\n\nAlways offer to save good jokes. If the user asks to save a joke, use the save_joke tool immediately. Ask the user for tag suggestions if they haven\'t provided them.\n\nKeep responses concise, friendly, and focused on comedy writing. Use emojis occasionally (ðŸ˜‚ ðŸŽ­ ðŸ’¡).',
            },
          },
          tools: {
            save_joke: {
              type: "client",
              description:
                "Save a joke to the user's Bitbinder (personal joke collection)",
              parameters: {
                type: "object",
                properties: {
                  content: {
                    type: "string",
                    description: "The joke text to save",
                  },
                  tags: {
                    type: "array",
                    items: { type: "string" },
                    description: "Tags for categorizing the joke",
                  },
                },
                required: ["content", "tags"],
              },
            },
          },
        };
      </script>
    </div>

    <!-- ElevenLabs Conversational AI Widget -->
    <script
      src="https://elevenlabs.io/convai-widget/index.js"
      async
      type="text/javascript"
    ></script>

    <!-- App Scripts (Firebase SDK loaded via ES module imports in app.js) -->
    <script type="module" src="app.js"></script>

    <!-- Firebase â†” Agent bridge: handles tool calls from the widget -->
    <script type="module" src="agent-bridge.js"></script>

    <!-- Text chat: type-to-agent functionality -->
    <script type="module" src="text-chat.js"></script>

    <!-- Mode toggle (non-module so onclick works) -->
    <script>
      function switchMode(mode) {
        const voiceMode = document.getElementById("voice-mode");
        const textMode = document.getElementById("text-mode");
        const voiceTab = document.getElementById("voice-tab");
        const textTab = document.getElementById("text-tab");

        if (mode === "voice") {
          voiceMode.style.display = "";
          textMode.style.display = "none";
          voiceTab.classList.add("active");
          textTab.classList.remove("active");
        } else {
          voiceMode.style.display = "none";
          textMode.style.display = "";
          voiceTab.classList.remove("active");
          textTab.classList.add("active");
          document.getElementById("message-input")?.focus();
        }
      }
    </script>
  </body>
</html>
