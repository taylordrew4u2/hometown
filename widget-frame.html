<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Voice Widget</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: transparent;
        width: 100%;
        height: 100%;
      }
      /*
        The ElevenLabs widget renders a position:fixed button at
        bottom-right of its viewport.  Since the iframe IS the viewport,
        the button lands in the bottom-right corner of this small frame.
      */
      elevenlabs-convai {
        display: block;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <elevenlabs-convai
      agent-id="agent_7401ka31ry6qftr9ab89em3339w9"
    ></elevenlabs-convai>

    <!-- Intercept WebSocket BEFORE widget script loads -->
    <script>
      (function () {
        const OrigWS = window.WebSocket;

        /*
          The ElevenLabs widget opens multiple WebSocket connections:
            - wss://api.elevenlabs.io (or api.us.elevenlabs.io) — conversational API (JSON transcript + tool calls)
            - wss://livekit.rtc.elevenlabs.io — LiveKit real-time audio signaling (mostly binary)
          We only track the API connection for transcript events and lifecycle.
        */
        var apiSocket = null; // reference to the conversational-API socket
        var openCount = 0; // how many ElevenLabs sockets are open

        function isApiSocket(url) {
          return (
            typeof url === "string" &&
            url.includes("elevenlabs.io") &&
            !url.includes("livekit")
          );
        }

        function isElevenLabsSocket(url) {
          return typeof url === "string" && url.includes("elevenlabs.io");
        }

        window.WebSocket = function (url, protocols) {
          var ws = protocols ? new OrigWS(url, protocols) : new OrigWS(url);

          if (isElevenLabsSocket(url)) {
            openCount++;
            console.log(
              "[widget-frame] WS open →",
              url,
              "  openCount:",
              openCount,
            );

            // Notify parent on FIRST ElevenLabs socket
            if (openCount === 1) {
              parent.postMessage({ type: "ws-open" }, "*");
            }

            // Only forward JSON messages from the conversational-API socket
            if (isApiSocket(url)) {
              apiSocket = ws;
              ws.addEventListener("message", function (e) {
                try {
                  parent.postMessage(
                    { type: "ws-message", data: JSON.parse(e.data) },
                    "*",
                  );
                } catch (_) {
                  /* binary audio frame — ignore */
                }
              });
            }

            ws.addEventListener("close", function () {
              openCount = Math.max(0, openCount - 1);
              console.log(
                "[widget-frame] WS close →",
                url,
                "  openCount:",
                openCount,
              );
              if (ws === apiSocket) apiSocket = null;
              // Only report close when ALL ElevenLabs sockets are gone
              if (openCount === 0) {
                parent.postMessage({ type: "ws-close" }, "*");
              }
            });

            ws.addEventListener("error", function (err) {
              console.error("[widget-frame] WS error →", url, err);
              openCount = Math.max(0, openCount - 1);
              if (ws === apiSocket) apiSocket = null;
              if (openCount === 0) {
                parent.postMessage({ type: "ws-close" }, "*");
              }
            });
          }

          return ws;
        };

        window.WebSocket.prototype = OrigWS.prototype;
        window.WebSocket.CONNECTING = OrigWS.CONNECTING;
        window.WebSocket.OPEN = OrigWS.OPEN;
        window.WebSocket.CLOSING = OrigWS.CLOSING;
        window.WebSocket.CLOSED = OrigWS.CLOSED;

        /* ---- Wire save_joke client tool ---- */
        function wireWidget() {
          var el = document.querySelector("elevenlabs-convai");
          if (!el) {
            setTimeout(wireWidget, 200);
            return;
          }

          /* Helper: handle a save_joke call and return a Promise for the result */
          function handleSaveJoke(params) {
            return new Promise(function (resolve) {
              var reqId = String(Date.now());
              parent.postMessage(
                { type: "save-joke", params: params, reqId: reqId },
                "*",
              );
              function onReply(evt) {
                if (
                  evt.data &&
                  evt.data.type === "save-joke-result" &&
                  evt.data.reqId === reqId
                ) {
                  window.removeEventListener("message", onReply);
                  resolve(evt.data.result);
                }
              }
              window.addEventListener("message", onReply);
              setTimeout(function () {
                window.removeEventListener("message", onReply);
                resolve("Timed out");
              }, 10000);
            });
          }

          /* Modern API: set clientTools property (object of name → handler) */
          function trySetClientTools() {
            try {
              el.clientTools = { save_joke: handleSaveJoke };
              console.log("[widget-frame] clientTools set via property");
              return true;
            } catch (_) {
              return false;
            }
          }

          /* Legacy API: registerClientTool (older widget versions) */
          function tryRegister() {
            if (typeof el.registerClientTool !== "function") return false;
            el.registerClientTool("save_joke", handleSaveJoke);
            console.log("[widget-frame] Registered via registerClientTool");
            return true;
          }

          /* Try both approaches */
          if (!trySetClientTools() && !tryRegister()) {
            el.addEventListener("elevenlabs-convai:ready", function () {
              trySetClientTools() || tryRegister();
            });
            var n = 0;
            var poll = setInterval(function () {
              if (trySetClientTools() || tryRegister() || ++n > 50)
                clearInterval(poll);
            }, 300);
          }

          /* catch-all tool call event (fallback) */
          el.addEventListener("elevenlabs-convai:call", function (e) {
            var d = e.detail || {};
            if (d.tool_name === "save_joke") {
              handleSaveJoke(d.parameters).then(function (result) {
                if (typeof d.callback === "function") d.callback(result);
              });
            }
          });
        }
        wireWidget();

        /* ---- Listen for signed URL from parent (agent-bridge.js) ---- */
        window.addEventListener("message", function (evt) {
          if (
            evt.data &&
            evt.data.type === "set-signed-url" &&
            evt.data.signedUrl
          ) {
            var el = document.querySelector("elevenlabs-convai");
            if (el) {
              // Apply the signed URL — the widget will use it instead of the plain agent-id
              el.setAttribute("signed-url", evt.data.signedUrl);
              console.log(
                "[widget-frame] signed-url applied to widget element",
              );
            }
          }
        });

        /* ---- Force the widget into a compact circle ---- */
        function styleWidgetButton() {
          var el = document.querySelector("elevenlabs-convai");
          if (!el || !el.shadowRoot) {
            setTimeout(styleWidgetButton, 300);
            return;
          }
          var style = document.createElement("style");
          style.textContent = `
            /* Hide EVERYTHING except the call button */
            :host {
              width: 64px !important;
              height: 64px !important;
              display: block !important;
              position: fixed !important;
              bottom: 0 !important;
              right: 0 !important;
              overflow: hidden !important;
            }
            /* Kill all elements by default */
            * {
              visibility: hidden !important;
            }
            /* Only show buttons (the call button) and their icon children */
            button {
              visibility: visible !important;
              width: 60px !important;
              height: 60px !important;
              min-width: 60px !important;
              max-width: 60px !important;
              min-height: 60px !important;
              max-height: 60px !important;
              border-radius: 50% !important;
              padding: 0 !important;
              overflow: hidden !important;
              display: flex !important;
              align-items: center !important;
              justify-content: center !important;
              position: fixed !important;
              bottom: 2px !important;
              right: 2px !important;
            }
            button * {
              visibility: visible !important;
            }
            /* Still hide text inside button */
            button span, button p {
              display: none !important;
            }
          `;
          el.shadowRoot.appendChild(style);

          /* Re-inject if shadow DOM rebuilds */
          var observer = new MutationObserver(function () {
            if (!el.shadowRoot.contains(style)) {
              el.shadowRoot.appendChild(style);
            }
          });
          observer.observe(el.shadowRoot, { childList: true, subtree: true });
        }
        styleWidgetButton();
      })();
    </script>

    <!-- Widget script loads AFTER our interception is in place -->
    <script src="https://elevenlabs.io/convai-widget/index.js" async></script>
  </body>
</html>
